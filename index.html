<script>
    let allData = [];
    const itemsPerPage = 20;
    let currentPage = 1;

    fetch('./collaborateurs.json')
        .then(response => response.json())
        .then(data => {
            allData = data;
            generatePositionsFilter(data);
            generateDepartmentsFilter(data);
            generateInterestsFilter(data); // Générer les options du filtre Centres d'Intérêts
            generateTrombinoscope(1, allData);
            updateCollaboratorCount(allData.length); // Initialiser le compteur de collaborateurs
        });

    // Événements pour filtrer
    document.getElementById('searchName').addEventListener('input', filterPeople);
    document.getElementById('filterDepartment').addEventListener('change', filterPeople);
    document.getElementById('filterPosition').addEventListener('change', filterPeople);
    document.getElementById('filterInterest').addEventListener('change', filterPeople);

    // Générer les options des filtres
    function generatePositionsFilter(data) {
        const filterPosition = document.getElementById('filterPosition');
        const uniquePositions = new Set();
        data.forEach(person => {
            if (person["poste"]) {
                uniquePositions.add(person["poste"]);
            }
        });
        uniquePositions.forEach(position => {
            const option = document.createElement('option');
            option.value = position;
            option.textContent = position;
            filterPosition.appendChild(option);
        });
    }

    function generateDepartmentsFilter(data) {
        const filterDepartment = document.getElementById('filterDepartment');
        const uniqueDepartments = new Set();
        data.forEach(person => {
            if (person["équipe"]) {
                uniqueDepartments.add(person["équipe"]);
            }
        });
        uniqueDepartments.forEach(department => {
            const option = document.createElement('option');
            option.value = department;
            option.textContent = department;
            filterDepartment.appendChild(option);
        });
    }

    function generateInterestsFilter(data) {
        const filterInterest = document.getElementById('filterInterest');
        const uniqueInterests = new Set();
        data.forEach(person => {
            if (person["Quels sont vos centres d'intérêts ?"]) {
                const interests = person["Quels sont vos centres d'intérêts ?"].split(', ');
                interests.forEach(interest => uniqueInterests.add(interest));
            }
        });
        uniqueInterests.forEach(interest => {
            const option = document.createElement('option');
            option.value = interest;
            option.textContent = interest;
            filterInterest.appendChild(option);
        });
    }

    // Filtrer les personnes
    function filterPeople() {
        const nameInput = document.getElementById('searchName').value.toLowerCase();
        const departmentFilter = document.getElementById('filterDepartment').value.toLowerCase();
        const positionFilter = document.getElementById('filterPosition').value.toLowerCase();
        const interestFilter = document.getElementById('filterInterest').value.toLowerCase();

        const filteredData = allData.filter(person => {
            const name = person["Nom et Prénom"].toLowerCase();
            const department = person["équipe"]?.toLowerCase() || '';
            const position = person["poste"]?.toLowerCase() || '';
            const interests = person["Quels sont vos centres d'intérêts ?"]?.toLowerCase() || '';

            return name.includes(nameInput) &&
                (department.includes(departmentFilter) || departmentFilter === "") &&
                (position.includes(positionFilter) || positionFilter === "") &&
                (interests.includes(interestFilter) || interestFilter === "");
        });

        generateTrombinoscope(1, filteredData);
        updateCollaboratorCount(filteredData.length); // Mettre à jour le compteur après filtrage
    }

    // Mettre à jour le compteur de collaborateurs
    function updateCollaboratorCount(count) {
        const countElement = document.getElementById('collaboratorCount');
        if (!countElement) {
            const newCountElement = document.createElement('p');
            newCountElement.id = 'collaboratorCount';
            newCountElement.style.textAlign = 'center';
            newCountElement.style.marginTop = '10px';
            newCountElement.style.fontSize = '16px';
            document.body.insertBefore(newCountElement, document.getElementById('trombinoscope'));
        }
        // Mettre à jour le texte du compteur
        document.getElementById('collaboratorCount').textContent = `Collaborateurs affichés : ${count}`;
    }

    // Générer le trombinoscope
    function generateTrombinoscope(page, data) {
        const trombinoscope = document.getElementById('trombinoscope');
        trombinoscope.innerHTML = '';
        const start = (page - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, data.length);

        for (let i = start; i < end; i++) {
            const person = document.createElement('div');
            person.classList.add('person');
            const imageUrl = data[i]["Vous pouvez ajouter une photo pour personnaliser votre profil et permettre aux autres de mieux associer votre visage à votre nom."] || "https://via.placeholder.com/150";

            person.innerHTML = `
                <img src="${imageUrl}" alt="Photo de ${data[i]["Nom et Prénom"]}" onclick="openModal(${i})">
                <div class="fixed-info">
                    <strong>Nom :</strong> ${data[i]["Nom et Prénom"]}<br>
                    <strong class="job">Poste :</strong> ${data[i].poste || 'Non renseigné'}<br>
                    <strong class="department">Équipe :</strong> ${data[i]["équipe"] || 'Non renseigné'}<br>
                    <strong>Email :</strong> ${data[i]["Votre adresse mail"] || 'Non renseigné'}<br>
                </div>
            `;
            trombinoscope.appendChild(person);
        }

        generatePagination(data);
    }

    // Pagination
    function generatePagination(data) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        const totalPages = Math.ceil(data.length / itemsPerPage);

        for (let page = 1; page <= totalPages; page++) {
            const button = document.createElement('button');
            button.innerText = page;
            button.onclick = () => {
                currentPage = page;
                generateTrombinoscope(page, data);
            };
            if (page === currentPage) {
                button.style.fontWeight = 'bold';
            }
            pagination.appendChild(button);
        }
    }

    // Ouvrir la modale
    function openModal(index) {
        const modal = document.getElementById('modal');
        const modalDetails = document.getElementById('modal-details');
        const person = allData[index];

        modalDetails.innerHTML = `
            <strong>Nom :</strong> ${person["Nom et Prénom"]}<br>
            <strong>Poste :</strong> ${person["poste"] || 'Non renseigné'}<br>
            <strong>Téléphone :</strong> ${person["Numéro de téléphone"] || 'Non renseigné'}<br>
            <strong>Équipe :</strong> ${person["équipe"] || 'Non renseigné'}<br>
            <strong>Statut professionnel :</strong> ${person["Statut professionnel"] || 'Non renseigné'}<br>
            <strong>Mail du supérieur hiérarchique :</strong> ${person["Le mail de votre supérieur hiérarchique"] || 'Non renseigné'}<br>
            <strong>Bâtiment :</strong> ${person["Bâtiment"] || 'Non renseigné'}<br>
            <strong>Étage :</strong> ${person["Etage"] || 'Non renseigné'}<br>
            <strong>Centres d'intérêts :</strong> ${person["Quels sont vos centres d'intérêts ?"] || 'Non renseigné'}<br>
            <strong>Profil LinkedIn :</strong> <a href="${person["Profil linkedin"] || '#'}" target="_blank">Voir le profil</a>
        `;
        modal.style.display = "block";
    }

    // Fermer la modale
    function closeModal() {
        const modal = document.getElementById('modal');
        modal.style.display = "none";
    }
</script>
